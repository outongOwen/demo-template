<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <style>
      .box {
        width: 1500px;
        height: 300px;
        background: greenyellow;
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
      }
      .scale {
        width: 165px;
        height: 10px;
        border-radius: 5px;
        background: cornflowerblue;
        position: absolute;
        left: 400px;
        top: 27%;
      }
      .scale-ball {
        display: inline-block;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        position: absolute;
        top: -2.5px;
        left: 135px;
        background: pink;
        cursor: pointer;
      }
      .scale-ball:before {
        content: attr(data-left);
        position: absolute;
        top: -20px;
        left: -20px;
        width: 40px;
        height: 40px;
        text-align: center;
      }
      .box > .time-line {
        width: 100%;
        height: 100%;
        position: absolute;
      }
      .time-line > .unit-line::before {
        content: attr(data-unit);
        position: absolute;
        top: -20px;
        left: -25px;
        width: 50px;
        text-align: center;
      }
      .video-el {
        position: absolute;
        left: 0;
        top: 150px;
        background-color: skyblue;
        height: 80px;
        border-radius: 8px;
      }
      .time {
        position: absolute;
        width: 2px;
        height: 500px;
        top: -40px;
        left: 50%;
        background: hotpink;
      }
      .time::before {
        content: "";
        position: absolute;
        left: -4px;
        top: -5px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: deeppink;
      }
    </style>
  </head>
  <body>
    <div class="scale"><div class="scale-ball"></div></div>
    <div class="box">
      <div class="time-line"></div>
      <div class="time"></div>
    </div>
  </body>
  <script>
    window.onload = () => {
      let video = {
        fps: 30,
        duration: 60,
      };

      let box = document.getElementsByClassName("time-line")[0];
      let timeLine = document.getElementsByClassName("time")[0];
      let fram,
        left = 150;
      let flag = false;
      let scale = 1;
      let unitList = [];
      let boxWidth = 1500;
      let bigStep = 150;
      let provLeft;
      let provUnitIndex = 0;
      let useUnit;
      let adjust = 2;

      /**
       * 模拟视频缩略图区域
       * @type {HTMLDivElement}
       */
      let videoEl = document.createElement("div");
      videoEl.className = "video-el";
      document.getElementsByClassName("box")[0].appendChild(videoEl);

      /**
       * 初始化缩放控制
       * @type {Element}
       */
      let dom = document.getElementsByClassName("scale-ball")[0];
      dom.setAttribute("data-left", left);
      dom.style.top = "-2.5px";
      dom.style.left = left + "px";

      /**
       * 创建时间单元
       * @param width
       * @param unit
       * @returns {HTMLDivElement}
       */
      function getLine(width, unit) {
        let line = document.createElement("div");
        line.className = "unit-line";
        line.style.position = "absolute";
        line.style.width = "1px";
        line.style.height = width + "px";
        line.style.backgroundColor = "black";
        if (unit) {
          line.setAttribute("data-unit", unit);
        }
        return line;
      }

      /**
       * 清空并更新时间轴时间
       * @param big 单元格宽度
       * @param unit 刻度单位
       * @param left 刻度偏移量
       */
      function setLine(big, unit, left = 0) {
        box.innerHTML = "";
        // 计算大单元格数量
        let start = Math.floor(Math.abs(left) / big);
        let max = Math.ceil(boxWidth / big) + start + 1;
        // 遍历生成大单元格
        for (let i = start; i <= max; i++) {
          // 遍历生成小单元格  小单元格数量在定义刻度对象时添加
          for (let ii = 1; ii < unit.smallNum; ii++) {
            if (
              ii === unit.smallNum ||
              (ii * big) / unit.smallNum + i * big + left < 0
            ) {
              continue;
            }
            let line1 = getLine(ii % 2 ? 12 : 16);
            line1.style.left =
              (ii * big) / unit.smallNum + i * big + left + "px";
            // 超出显示区域的不继续绘制
            if ((ii * big) / unit.smallNum + i * big > boxWidth - left) {
              break;
            }
            box.appendChild(line1);
          }
          if (i * big + left < 0 || i * big + left > boxWidth) {
            continue;
          }
          let unitShow = unit.num * i;
          if (unit.unit === "f") {
            let s = unitShow % video.fps;
            if (!s) {
              unitShow = unitShow / video.fps + "s";
            } else {
              unitShow = (unitShow % video.fps) + unit.unit;
            }
          } else {
            let m = unitShow % 60;
            if (!m) {
              let h = unitShow % 3600;
              if (!h) {
                unitShow = unitShow / 3600 + "h";
              } else {
                unitShow = ((unitShow / 60) % 60) + "m";
              }
            } else {
              unitShow = (unitShow % 60) + unit.unit;
            }
          }
          let line = getLine(24, unitShow);
          line.style.left = i * big + left + "px";
          box.appendChild(line);
        }
      }

      /**
       * 帧动画绘制
       */
      function frameAnimate() {
        fram = window.requestAnimationFrame(() => {
          if (!flag) {
            window.cancelAnimationFrame(fram);
          }
          // 进度条发生改变时触发操作
          if (left === provLeft) {
            return frameAnimate();
          }

          // 判断使用哪一个刻度单位
          // 缩放节点长度
          let stepUnit = 150 / unitList.length;
          // 超出缩放节点长度
          let step = left % stepUnit;
          // 按刻度列表 最小刻度在最前面
          let index = unitList.length - Math.ceil(left / stepUnit);

          // stepUnit 可能不是整数
          // 限制进度到达两端的切换操作
          if (left / stepUnit > unitList.length) {
            index = 0;
          }
          if (left === 0) {
            index = unitList.length - 1;
          }

          //刻度单位发生改变继续操作
          if (index !== provUnitIndex) {
            provUnitIndex = index;
            let nextUnit = unitList[index];
            // index === 0 进度为150 此时缩放倍率没有参考 设置为最大放大两倍
            // 单元格宽度初始化为1倍宽度  所以参考放大极限为 单元格放大到刻度和下一个单位对齐时切换刻度
            if (index === 0) {
              adjust = 2;
            } else {
              // nextUnit 是当前要切换的单位的刻度对象
              // next 是下一个更小单位的刻度对象
              let next = unitList[index - 1];
              // adjust 作为放大倍率限制参数必须大于1 虽然不太可能出现 nextUnit.num / next.num < 0 在此以防万一
              let useFps =
                nextUnit.unit === "s" ? nextUnit.num * video.fps : nextUnit.num;
              let nextFps = next.unit === "s" ? next.num * video.fps : next.num;
              adjust = useFps > nextFps ? useFps / nextFps : nextFps / useFps;
            }
            // 切换刻度
            useUnit = nextUnit;
          }
          // 在特殊节点 --- 当前单位缩放极限和下一单位初始缩放位置
          // 缩放按放大到极限算 否则会出现跳动
          if (left === 150 || (step === 0 && left !== 0)) {
            step = stepUnit;
          }
          // 初始为一倍  放大极限 >1 的部分  对step/stepUnit --- 当前缩放进度  进行调节
          scale = (step / stepUnit) * (adjust - 1) + 1;
          setTimeLineLeft(scale);
          // 记录当前缩放位置
          provLeft = left;
          //模拟视频模块设置宽度
          if (videoEl) {
            let leftNum;
            if (useUnit.unit === "s") {
              leftNum = (video.duration / useUnit.num) * bigStep * scale;
            } else {
              leftNum = ((video.duration * 30) / useUnit.num) * bigStep * scale;
            }
            videoEl.style.width = leftNum + "px";
          }

          frameAnimate();
        });
      }

      let timeLineTime = video.duration / 2;
      function setTimeLineLeft(scale) {
        let ftpNum = timeLineTime * 30;
        let baseTimeLineLeft =
          (ftpNum / (useUnit.unit === "s" ? useUnit.num * 30 : useUnit.num)) *
          bigStep;
        let comTimeLineLeft = baseTimeLineLeft * scale;
        let left = boxWidth / 2;
        let boxMove = 0;

        if (comTimeLineLeft > left) {
          boxMove = left - comTimeLineLeft;
          videoEl.style.left = boxMove + "px";
          comTimeLineLeft = left;
        } else if (videoEl.style.transform !== "translateX(0)px") {
          videoEl.style.left = 0;
        }
        timeLine.style.left = comTimeLineLeft + "px";

        //重新绘制刻度线
        setLine(bigStep * scale, useUnit, boxMove);
      }
      /**
       * 时间轴刻度的列表
       * 分钟级刻度
       * @param num 初始秒数 这里初始为60s及一分钟
       * @param mult 倍数是为了适配上级单位 这里初始60 一分钟的60倍--1h
       */
      let baseUnitList = [];
      function setUniList(num, mult, unit) {
        let newNum = Math.ceil(num / 2);
        if (!(60 % num)) {
          baseUnitList.unshift({
            num: num * mult,
            unit: unit,
            smallNum: 10,
          });
        } else {
          newNum = Math.ceil(num / 10) * 10;
        }
        if ((newNum * mult) / 2 >= 1 && num !== newNum) {
          setUniList(newNum, mult, unit);
        } else if (mult > 1) {
          setUniList(30, mult / 60, unit);
        }
      }
      setUniList(60, 60, "s");

      // 根据视频帧率匹配帧级刻度
      //基本能适配 24fps、25fps、30fps、50fps、60fps、120fps
      let getFpsControl = [120, 60, 30, 25, 24, 15, 12, 10, 5, 4, 3, 2].filter(
        (v) => !(video.fps % v),
      );
      getFpsControl.forEach((v) => {
        let smallNum = [10, 5, 3, 2].find((vv) => !(v % vv));
        baseUnitList.unshift({
          num: v,
          unit: "f",
          smallNum: smallNum,
        });
      });

      /**
       * 从刻度列表中选取刻度区间
       *  1H 以上显示的到20s级别
       *  10M 以上显示到15帧级别
       *  从列表中匹配 按单元刻度显示视频居中位置单元格大小
       *  选取单元格大小在50-100px的刻度
       *  刻度单位小于该刻度的加入刻度列表
       */
      function setTimeLineTime() {
        //如果视频太长小刻度就去掉
        if (video.duration > 7200) {
          baseUnitList.splice(0, 10);
        } else if (video.duration > 3600) {
          baseUnitList.splice(0, 8);
        } else if (video.duration > 600) {
          baseUnitList.splice(0, 4);
        }
        unitList = [];
        // 找到单位刻度长度在 50 - 100 的刻度
        let index = baseUnitList.findIndex((v, i) => {
          let baseUnitNum;
          if (v.unit === "f") {
            baseUnitNum = (video.duration * video.fps) / v.num;
          } else if (v.unit === "s") {
            baseUnitNum = video.duration / v.num;
          }
          let unitWidth = boxWidth / 2 / baseUnitNum;
          if (unitWidth >= 50 && unitWidth <= 100) {
            bigStep = unitWidth;
            return i;
          }
        });

        //初始化刻度列表和刻度对象
        unitList = baseUnitList.slice(0, index + 1);
        useUnit = unitList[0];
      }

      /**
       * 监听鼠标移动控制 帧动画的开启和关闭
       */
      dom.addEventListener("mousedown", (e) => {
        flag = true;
        frameAnimate();
      });
      document.addEventListener("mousemove", (e) => {
        if (flag) {
          left = Number(dom.style.left.split("px")[0]) + e.movementX;
          if (left < 0) {
            left = 0;
          }
          if (left > 150) {
            left = 150;
          }
          dom.setAttribute("data-left", left);
          dom.style.left = left + "px";
        }
      });
      document.addEventListener("mouseup", (e) => {
        if (flag) {
          flag = false;
        }
      });

      setTimeLineTime();

      /**
       * 初始化
       */
      left = 0;
      dom.setAttribute("data-left", left);
      dom.style.left = left + "px";
      frameAnimate();
    };
  </script>
</html>
